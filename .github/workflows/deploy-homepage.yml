name: 构建和部署主页

on:
  workflow_dispatch:
  # 推送到 main 分支时也运行
  push:
    branches: [ main ]
    paths:
      - 'README.md'
      - 'README_zh.md'

# 设置 GITHUB_TOKEN 权限以允许部署到 GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# 仅允许一个并发部署，跳过正在运行的运行与最新排队的运行之间的队列。
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAGES: true
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit
      - name: 检出仓库
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: 设置 Pages
        uses: actions/configure-pages@v4

      - name: 创建主页目录
        run: mkdir -p _site

      - name: 使用 iFlow CLI 生成主页
        uses: iflow-ai/iflow-cli-action@v2.0.0
        with:
          precmd: "ls -al"
          prompt: |
            读取当前仓库的 README.md 文件，将其转换为专为 AstrBot 插件设计的精美产品文档网站并保存为 _site/index.html。

            要求：
            1. 使用 HTML5 + CSS3 构建精美优雅的 AstrBot 插件文档网站，注重视觉美感与用户体验
            2. 页面结构（插件专用文档站）：
               - 顶部导航栏：项目名称 "astrbot_plugin_interactive"、主要导航（首页、功能介绍、安装使用、命令详解、配置说明、贡献指南）、GitHub链接
               - Hero 区域：项目标题、副标题（"一个功能丰富的AstrBot互动游戏插件"）、功能亮点概览
               - 主内容区：采用两栏布局（边栏导航+主体内容）
                 * 左侧边栏：文档目录导航（插件概览、功能特性、安装指南、使用教程、命令列表、常见问题），快速跳转链接
                 * 中间内容：文档主体，优雅的排版，最大宽度 900px，舒适阅读体验
               - 特色功能展示区：使用图标和简短描述展示各项游戏功能（签到、抽奖、猜数字、牛牛系统等）
               - 安装指导区：清晰的安装步骤和配置说明
               - 命令参考区：完整的命令列表和使用示例
               - 底部：项目信息、GitHub链接、许可证、贡献者信息

            3. 视觉设计（插件友好风格）：
               - 主色调：AstrBot 主题色或适合机器人的科技蓝色（如 #3B82F6）
               - 辅助色：绿色（#10B981）表示成功、橙色（#F59E0B）表示警告
               - 背景色：白色（#FFFFFF）或浅灰（#F9FAFB）
               - 字体：现代字体栈（Inter, system-ui, -apple-system 等）
               - 阴影：微妙阴影营造层次感
               - 圆角：6px-8px 圆角
               - 动画：平滑过渡效果

            4. 排版美学（插件文档优化）：
               - H1：2.25rem（36px），颜色 #1F2937，字重 700，字母间距 -0.025em
               - H2：1.875rem（30px），颜色 #374151，字重 600，字母间距 -0.025em
               - H3：1.5rem（24px），颜色 #4B5563，字重 600
               - H4：1.25rem（20px），颜色 #6B7280，字重 500
               - 正文：1rem（16px），行高 1.75，颜色 #4B5563
               - 代码：等宽字体 JetBrains Mono，0.9rem，行高 1.5，背景 #F3F4F6
               - 段落间距：1.75em
               - 代码块：突出显示，带有复制按钮

            5. 顶部导航设计：
               - 背景：白色或轻微毛玻璃效果
               - 高度：64px
               - 项目名称：左对齐，醒目展示 "astrbot_plugin_interactive"
               - 导航项：居中或靠右，清晰的导航标签
               - GitHub链接：右对齐，品牌色图标

            6. Hero 区域设计：
               - 背景：轻微渐变或几何图案
               - 标题：项目名称，清晰易读
               - 副标题：简洁的项目定位描述
               - 功能亮点：3-4个关键功能的小图标展示

            7. 代码展示美化（适用于配置示例）：
                - 使用 Prism.js，适合插件的代码主题
                - 优雅语法高亮
                - 代码块背景：轻微着色
                - 复制按钮：便捷的代码复制功能

            8. 插件相关内容优化：
                - 命令格式：清晰展示命令格式，如 "/sign"、"/lottery" 等
                - 配置说明：清晰展示配置项和示例
                - 安装步骤：有序的安装说明列表
                - 功能特点：使用图标和卡片展示不同功能

            9. 响应式设计（全设备适配）：
                - 桌面（≥1200px）：完整布局
                - 平板（768px-1199px）：自适应布局
                - 移动（<768px）：单列布局，导航菜单优化

            10. 交互特效（适度动效）：
                - 导航项悬停效果
                - 代码块复制动画
                - 卡片悬停提升效果
                - 平滑滚动和锚点跳转

            11. 性能与技术实现：
                - 从 CDN 引入：Prism.js + Inter 字体
                - 使用 CSS Grid + Flexbox 布局
                - CSS 自定义属性定义主题色
                - 原生 JavaScript 实现轻量交互
                - SVG 图标展示功能
                - 轻量化资源，优化加载速度

            请创建完整的 HTML 文件，使用优雅的内联 CSS 和 JavaScript，确保文件自包含且可直接运行，重点体现精美、现代和优雅的设计风格，特别突出插件的特性与功能。
            项目地址：https://github.com/xiaomizhoubaobei/astrbot_plugin_interactive
          api_key: ${{ secrets.IFLOW_API_KEY }}
          # settings_json: ${{ secrets.IFLOW_SETTINGS_JSON }}
          model: "qwen3-coder-plus"
          timeout: "1800"
          debug: "true"

      - name: 验证 Wiki 网站已生成
        run: |
          if [ -f "_site/index.html" ]; then
            echo "Wiki 网站生成成功！"
            echo "正在检查网站内容..."
            if grep -q "<!DOCTYPE html>" "_site/index.html"; then
              echo "✓ 检测到有效的 HTML5 文档"
            else
              echo "⚠ 警告：生成的文件可能不是有效的 HTML 文档"
            fi
            ls -la _site/
          else
            echo "错误：Wiki 网站未由 iFlow 生成"
            exit 1
          fi

      - name: 上传构建产物
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
